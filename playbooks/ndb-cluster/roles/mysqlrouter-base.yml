--- # Install and configure MySQL Router

- hosts: ndb-cluster-router
  remote_user: ansible
  become: yes
  become_method: sudo
  connection: ssh
  gather_facts: yes
  roles: 
    - ndb-cluster-router
  tasks:
  - name: Ensure the mysql group exists
    group:
      name: mysql
      state: present
  - name: Ensure the mysql user exists
    user:
      name: mysql
      state: present
  - name: Create MySQL Router Config Directory
    file: 
      path: /usr/local/mysql-router
      state: directory
  - name: Download MySQL Repository
    get_url:
      url: https://dev.mysql.com/get/mysql80-community-release-el7-1.noarch.rpm
      dest: /tmp/mysql80-community-release-el7-1.noarch.rpm
  - name: Install MySQL Repo
    yum:
      name: /tmp/mysql80-community-release-el7-1.noarch.rpm
      state: present
  - name: Stop and Disable the MySQL Service
    systemd:
      state: stopped
      enabled: false
      name: mysqld
  - name: Make sure MariaDB Libs are removed
    yum:
      name: mariadb-libs
      state: absent
  - name: Install MySQL Server
    yum:
      name: mysql-server
      state: present
  - name: Install MySQL Router
    yum:
      name: https://dev.mysql.com/get/Downloads/MySQL-Router/mysql-router-8.0.12-1.el7.x86_64.rpm
      state: present
  - name: Deploy config file
    template: 
      src: ndb-cluster-router/templates/mysqlrouter.conf
      dest: /usr/local/mysql-router/mysqlrouter.conf
