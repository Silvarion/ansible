--- # Tryout to deploy a full NDB Cluster on CentOS 7

- hosts: ndb-cluster
  remote_user: ansible
  become: yes
  become_method: sudo
  connection: ssh
  gather_facts: yes
  roles: 
    - ndb-cluster
  tasks:
  - name: Ensure the mysql group exists
    group:
      name: mysql
      state: present
  - name: Ensure the mysql user exists
    user:
      name: mysql
      state: present
  - name: Download MySQL Repository
    get_url:
      url: https://dev.mysql.com/get/mysql80-community-release-el7-1.noarch.rpm
      dest: /tmp/mysql80-community-release-el7-1.noarch.rpm
  - name: Install MySQL Repo
    yum:
      name: /tmp/mysql80-community-release-el7-1.noarch.rpm
      state: present
  - name: Make sure MariaDB Libs are removed
    yum:
      name: mariadb-libs
      state: absent
  - name: Download MySQL Cluster Community
    get_url:
      url: https://dev.mysql.com/get/Downloads/MySQL-Cluster-7.6/mysql-cluster-community-7.6.7-1.el7.x86_64.rpm-bundle.tar
      dest: /tmp/mysql-cluster-community-7.6.7-1.el7.x86_64.rpm-bundle.tar
  - name: Unarchive MySQL Cluster Community
    unarchive:
      src: /temp/MySQL-Cluster-7.6/mysql-cluster-community-7.6.7-1.el7.x86_64.rpm-bundle.tar
      dest: /tmp
  - name: Install MySQL Cluster Common RPM
    yum:
      name: /tmp/mysql-cluster-community-common-7.6.7-1.el7.x86_64.rpm
      state: present
  - name: Install MySQL Cluster Libs RPM
    yum:
      name: /tmp/mysql-cluster-community-libs-7.6.7-1.el7.x86_64.rpm
      state: present
  - name: Install MySQL Cluster Client RPM
    yum:
      name: /tmp/mysql-cluster-community-client-7.6.7-1.el7.x86_64.rpm
      state: present
  - name: Install MySQL Cluster Server RPM
    yum:
      name: /tmp/mysql-cluster-community-server-7.6.7-1.el7.x86_64.rpm
      state: present
  - name: Install MySQL Cluster Data Node RPM
    yum:
      name: /tmp/mysql-cluster-community-data-node-7.6.7-1.el7.x86_64.rpm
      state: present
  - name: Install MySQL Cluster MemCache RPM
    yum:
      name: /tmp/mysql-cluster-community-memcached-7.6.7-1.el7.x86_64.rpm
      state: present
  - name: Install MySQL Cluster Management Server RPM
    yum:
      name: /tmp/mysql-cluster-community-management-server-7.6.7-1.el7.x86_64.rpm
      state: present
  - name: Install MySQL Cluster Common RPM
    yum:
      name: /tmp/mysql-cluster-community-ndbclient-7.6.7-1.el7.x86_64.rpm
      state: present
  - name: Create ndb cluster directory
    file:
      path: /var/lib/mysql-cluster
      state: directory
  - name: Write the ndb cluster config file
    template:
      src: ndb-cluster/templates/config.ini
      dest: /var/lib/mysql-cluster/config.ini
  - name: Write the my.cnf config file
    template:
      src: ndb-cluster/templates/my.cnf
      dest: /etc/my.cnf
  - name: Write the etc hosts config file
    template:
      src: ndb-cluster/templates/hosts
      dest: /etc/hosts